<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile - FastAPI Calculator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #e4e4e7;
      margin: 0;
      padding: 40px;
      min-height: 100vh;
      background-color: #09090b;
      background-image: radial-gradient(circle at 50% 0%, #2e1065, #09090b 80%);
    }

    .card {
      background-color: #1e1e20;
      border: 1px solid #333333;
      border-radius: 12px;
      padding: 24px;
      max-width: 460px;
      margin: 40px auto;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
    }

    h1 { margin: 0 0 10px 0; }
    h2 { font-size: 1.1rem; margin: 0 0 10px 0; }

    label { display:block; font-size:0.85rem; color:#a1a1aa; margin-top:12px; margin-bottom:6px; }
    input {
      width: 100%;
      background-color: #121212;
      border: 1px solid #3f3f46;
      color: #ffffff;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    input:focus { border-color: #a855f7; outline: none; box-shadow: 0 6px 18px rgba(168,85,247,0.12); }

    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      margin-top: 14px;
      margin-right: 10px;
    }
    .btn-primary { background-color: #a855f7; color: #fff; }
    .btn-secondary { background-color: #3f3f46; color: #fff; }

    .msg { margin-top: 10px; font-size: 0.9rem; }
    .muted { color:#a1a1aa; font-size:0.85rem; }

    hr { margin: 22px 0; border: none; border-top: 1px solid #333; }

    /* Light theme support */
    body[data-theme="light"]{
      background-color: #f3f4f6;
      background-image: radial-gradient(circle at 50% 0%, #eef2ff, #f3f4f6 80%);
      color: #0f172a;
    }
    body[data-theme="light"] .card{ background:#ffffff; border:1px solid #e6e6e9; color:#0f172a }
    body[data-theme="light"] label{ color:#6b7280 }
    body[data-theme="light"] input{ background:#ffffff; color:#0f172a; border:1px solid #d1d5db }
    body[data-theme="light"] .btn-primary{ background:#7c3aed; color:#fff }
    body[data-theme="light"] .btn-secondary{ background:#e5e7eb; color:#0f172a }
  </style>
</head>
<body>
  <div style="position:fixed;right:24px;top:18px;z-index:999">
    <button id="themeToggle"
      style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;
             padding:8px 10px;border-radius:8px;cursor:pointer">
      ðŸŒ™
    </button>
  </div>

  <div class="card">
    <h1>Account</h1>
    <div class="muted">Update your profile info or change your password.</div>

    <hr />

    <h2>Profile Info</h2>
    <form id="profileForm" novalidate>
      <label>Username</label>
      <input id="username" type="text" minlength="3" required />

      <label>Email</label>
      <input id="email" type="email" required />

      <button class="btn btn-primary" type="submit">Update Profile</button>
      <button id="backBtn" class="btn btn-secondary" type="button">Back to Calculations</button>
      <div id="profileMsg" class="msg"></div>
    </form>

    <hr />

    <h2>Change Password</h2>
    <form id="passwordForm" novalidate>
      <label>Current Password</label>
      <input id="oldPassword" type="password" minlength="6" required />

      <label>New Password</label>
      <input id="newPassword" type="password" minlength="6" required />

      <label>Confirm New Password</label>
      <input id="confirmNewPassword" type="password" minlength="6" required />

      <button class="btn btn-primary" type="submit">Change Password</button>
      <div id="passwordMsg" class="msg"></div>
    </form>
  </div>

  <script>
    const tokenKey = 'token';

    // Theme toggle
    (function setupTheme(){
      try{
        const btn = document.getElementById('themeToggle');
        const stored = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', stored);
        function updateBtn(){ btn.innerText = document.body.getAttribute('data-theme') === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸'; }
        updateBtn();
        btn.addEventListener('click', ()=>{
          const cur = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          document.body.setAttribute('data-theme', cur);
          localStorage.setItem('theme', cur);
          updateBtn();
        });
      }catch(e){}
    })();

    function authHeader() {
      const t = localStorage.getItem(tokenKey);
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    // Protect page
    const token = localStorage.getItem(tokenKey);
    if (!token) window.location.href = '/login';

    const profileForm = document.getElementById('profileForm');
    const passwordForm = document.getElementById('passwordForm');
    const profileMsg = document.getElementById('profileMsg');
    const passwordMsg = document.getElementById('passwordMsg');

    document.getElementById('backBtn').addEventListener('click', ()=>{
      window.location.href = '/calculations';
    });

    async function loadProfile() {
      try {
        const res = await fetch('/api/users/me', { headers: { ...authHeader(), 'Accept': 'application/json' } });
        if (!res.ok) return;
        const u = await res.json();
        document.getElementById('username').value = u.username || '';
        document.getElementById('email').value = u.email || '';
      } catch (e) {}
    }
    loadProfile();

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      profileMsg.innerText = '';

      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();

      if (username.length < 3) {
        profileMsg.innerText = 'Username must be at least 3 characters.';
        return;
      }
      if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
        profileMsg.innerText = 'Enter a valid email address.';
        return;
      }

      try {
        const res = await fetch('/api/users/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeader() },
          body: JSON.stringify({ username, email })
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          profileMsg.innerText = err.detail || 'Update failed';
          return;
        }

        profileMsg.innerText = 'Profile updated!';
        loadProfile();
      } catch (e) {
        profileMsg.innerText = 'Network error';
      }
    });

    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      passwordMsg.innerText = '';

      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNew = document.getElementById('confirmNewPassword').value;

      if (newPassword.length < 6) {
        passwordMsg.innerText = 'New password must be at least 6 characters.';
        return;
      }
      if (newPassword !== confirmNew) {
        passwordMsg.innerText = 'New password and confirm password do not match.';
        return;
      }

      try {
        const res = await fetch('/api/users/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeader() },
          body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          passwordMsg.innerText = err.detail || 'Password change failed';
          return;
        }

        passwordMsg.innerText = 'Password changed! Please login again.';
        localStorage.removeItem(tokenKey);

        setTimeout(()=> window.location.href = '/login', 600);
      } catch (e) {
        passwordMsg.innerText = 'Network error';
      }
    });
  </script>
</body>
</html>
