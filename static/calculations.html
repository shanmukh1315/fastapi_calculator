<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculations - FastAPI Calculator</title>
  <style>
    /* Dark & Sleek ‚Äî full-bleed matte background and narrow centered column */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #e4e4e7;
      margin: 0;
      padding: 40px;
      min-height: 100vh;
      /* Midnight Purple Glow to match register */
      background-color: #09090b;
      background-image: radial-gradient(circle at 50% 0%, #2e1065, #09090b 80%);
      display:flex;justify-content:center;
    }

    /* Narrow mobile-app style container */
    .main-container { width:100%; max-width:760px; }
    .container { width:100%; max-width:760px; }

    h1 { color:#ffffff; font-size:1.6rem; margin:0 0 6px 0 }
    p.small-muted { color: #71717a; margin:0 0 14px 0 }

    .card {
      background-color: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
    }

    .card h2 { color:#ffffff; margin:0 0 12px 0; font-size:1.05rem }

    label { display:block; font-size:0.85rem; color:#a1a1aa; margin-bottom:6px }
    input[type="text"], input[type="number"], select { width:100%; background:#18181b; border:1px solid #3f3f46; color:#fff; padding:12px; border-radius:8px; margin-bottom:12px }
    input:focus, select:focus { outline:none; border-color:#a855f7 }

    .token-display, .token-bar .token-show { background:#3f3f46; color:#e4e4e7; padding:8px 10px; border-radius:6px; font-family:monospace; display:inline-block }

    .form-row{display:flex;gap:12px}
    .form-row.three > div{flex:1}
    @media(max-width:520px){ .form-row{flex-direction:column} }

    .btn{background:#a855f7;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer}
    .btn-secondary{background:#3f3f46;color:#fff;border-radius:8px;padding:10px 12px}
    .btn-danger{background:#ef4444;color:#fff;padding:8px;border-radius:6px}

    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:13px;font-weight:600}
    .pill-add{background:#e6ffef;color:#047857}
    .pill-subtract{background:#fff7ed;color:#92400e}
    .pill-multiply{background:#eef2ff;color:#3730a3}
    .pill-divide{background:#fff0f6;color:#831843}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;text-align:left;color:#d4d4d8}
    .actions button{margin-left:6px}

    .muted{color:#a1a1aa;font-size:13px}
    .msg{margin-top:8px;font-size:14px;color:#e4e4e7}
  </style>
</head>
<body>
  <div class="page-frame" style="background:transparent;padding:0">
    <div class="container main-container">
    <h1>Calculations (BREAD)</h1>
    <p class="small-muted">Manage your calculations securely using your token.</p>

    <div class="card" id="auth">
      <h2>Token</h2>
      <div class="token-bar">
        <div class="muted">Token: <span class="token-show" id="tokenShow">(not set)</span></div>
        <label class="muted">Paste token (or use login page to store it):</label>
        <input id="tokenInput" placeholder="Paste raw token here" />
        <div style="margin-top:10px">
          <button id="setToken" class="btn btn-primary">Set token</button>
          <button id="clearToken" class="btn btn-secondary">Clear token</button>
          <span id="authMsg" class="muted" style="margin-left:12px"></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Create / Edit Calculation</h2>
      <form id="calcForm" novalidate>
        <input type="hidden" id="calcId" />
        <div class="form-row three">
          <div>
            <label>Operand A</label>
            <input id="a" type="number" step="any" required />
          </div>
          <div>
            <label>Operation</label>
            <select id="type">
              <option value="add">add</option>
              <option value="subtract">subtract</option>
              <option value="multiply">multiply</option>
              <option value="divide">divide</option>
            </select>
          </div>
          <div>
            <label>Operand B</label>
            <input id="b" type="number" step="any" required />
          </div>
        </div>
        <div id="formMsg" class="msg"></div>
        <div style="margin-top:12px">
          <button id="submitBtn" class="btn btn-primary">Create</button>
          <button id="cancelEdit" type="button" class="btn btn-secondary" style="display:none;margin-left:8px">Cancel Edit</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Your Calculations</h2>
      <div id="listMsg" class="muted"></div>
      <table id="calcTable">
        <thead><tr><th>ID</th><th>A</th><th>Type</th><th>B</th><th>Result</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <script>
    const tokenKey = 'token';
    const tokenShow = document.getElementById('tokenShow');
    const tokenInput = document.getElementById('tokenInput');
    const setTokenBtn = document.getElementById('setToken');
    const clearTokenBtn = document.getElementById('clearToken');
    const authMsg = document.getElementById('authMsg');

    function showToken() {
      const t = localStorage.getItem(tokenKey);
      tokenShow.innerText = t ? (t.length > 28 ? t.slice(0, 24) + '...' : t) : '(not set)';
    }
    showToken();

    setTokenBtn.addEventListener('click', () => {
      const v = tokenInput.value.trim();
      if (!v) return authMsg.innerText = 'Enter token';
      localStorage.setItem(tokenKey, v);
      tokenInput.value = '';
      showToken();
      authMsg.innerText = '';
      showToast('Token set \u2705', 'success');
      loadList();
    });

    clearTokenBtn.addEventListener('click', () => {
      localStorage.removeItem(tokenKey);
      showToken();
      authMsg.innerText = '';
      showToast('Token cleared', '');
      loadList();
    });

    const form = document.getElementById('calcForm');
    const aEl = document.getElementById('a');
    const bEl = document.getElementById('b');
    const typeEl = document.getElementById('type');
    const msg = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEdit = document.getElementById('cancelEdit');
    const tableBody = document.querySelector('#calcTable tbody');
    const listMsg = document.getElementById('listMsg');

    function authHeader() {
      const t = localStorage.getItem(tokenKey);
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    async function loadList() {
      tableBody.innerHTML = '';
      listMsg.innerText = '';
      try {
        const res = await fetch('/api/calculations', { headers: { ...authHeader(), 'Accept': 'application/json' } });
        if (res.status === 401) { listMsg.innerText = 'Unauthorized - set token'; return; }
        const data = await res.json();
        if (!Array.isArray(data)) { listMsg.innerText = 'Error loading list'; return; }
        data.forEach(c => {
          const tr = document.createElement('tr');
          // make a type pill
          const typeClass = 'pill-' + (c.type || '').toLowerCase();
          const typeHtml = `<span class="pill ${typeClass}">${c.type}</span>`;
          tr.innerHTML = `<td>${c.id}</td><td>${c.a}</td><td>${typeHtml}</td><td>${c.b}</td><td>${c.result}</td>
            <td class="actions">
              <button data-id="${c.id}" class="btn btn-secondary edit" aria-label="Edit">‚úèÔ∏è</button>
              <button data-id="${c.id}" class="btn btn-danger del" aria-label="Delete">üóëÔ∏è</button>
            </td>`;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        listMsg.innerText = 'Network error';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.innerText = '';
      const a = parseFloat(aEl.value);
      const b = parseFloat(bEl.value);
      const type = typeEl.value;
      if (isNaN(a) || isNaN(b)) { msg.innerText = 'Operands must be numbers'; msg.className = 'error'; return; }
      const payload = { a, b, type };
      const id = document.getElementById('calcId').value;
      try {
        let res;
        if (id) {
          res = await fetch('/api/calculations/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify(payload) });
        } else {
          res = await fetch('/api/calculations', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify(payload) });
        }
        if (res.status === 401) { msg.innerText = 'Unauthorized'; msg.className = 'error'; return; }
        if (res.status >= 400) { const j = await res.json(); msg.innerText = j.detail || 'Error'; msg.className = 'error'; return; }
        const j = await res.json();
        msg.innerText = '';
        showToast(id ? 'Calculation updated' : 'Calculation created', 'success');
        resetForm();
        loadList();
      } catch (err) { msg.innerText = 'Network error'; msg.className = 'error'; }
    });

    tableBody.addEventListener('click', async (e) => {
      if (e.target.classList.contains('edit')) {
        const id = e.target.getAttribute('data-id');
        // load calc
        const res = await fetch('/api/calculations/' + id, { headers: { ...authHeader() } });
        if (res.status === 200) {
          const c = await res.json();
          document.getElementById('calcId').value = c.id;
          aEl.value = c.a; bEl.value = c.b; typeEl.value = c.type;
          submitBtn.innerText = 'Update'; cancelEdit.style.display = 'inline-block';
        } else {
          listMsg.innerText = 'Could not load calculation';
        }
      }
      if (e.target.classList.contains('del')) {
        const id = e.target.getAttribute('data-id');
        if (!confirm('Delete calculation ' + id + '?')) return;
        const res = await fetch('/api/calculations/' + id, { method: 'DELETE', headers: { ...authHeader() } });
        if (res.status === 200) { showToast('Deleted', ''); loadList(); } else { listMsg.innerText = 'Delete failed'; }
      }
    });

    cancelEdit.addEventListener('click', () => resetForm());
    function resetForm() { document.getElementById('calcId').value = ''; aEl.value=''; bEl.value=''; submitBtn.innerText='Create'; cancelEdit.style.display='none'; msg.innerText=''; }

    // initial load
    loadList();

    // small toast helper
    function showToast(text, type){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div');
      el.className = 'toast' + (type?(' '+type):'');
      el.innerText = text;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=>wrap.removeChild(el),300) }, 2600);
    }
  </script>
</body>
</html>
