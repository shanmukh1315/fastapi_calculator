<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculations - FastAPI Calculator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    
    /* 1. Global Reset & Body (Matches Login/Register) */
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #e4e4e7;
      margin: 0;
      padding: 40px;
      min-height: 100vh;
      /* Background matches Login exactly */
      background-color: #09090b;
      background-image: radial-gradient(circle at 50% 0%, #2e1065, #09090b 80%);
      display: flex;
      justify-content: center; /* Centers the column */
    }

    /* 2. Layout Containers (Matches Login widths) */
    .page-frame { 
        max-width: 980px; 
        width: 100%;
        margin: 0 auto; 
        background: transparent; 
        padding: 0; 
    }
    .container { 
        width: 100%; 
        max-width: 920px; /* Aligns with Login container width */
        margin: 0 auto; 
    }

    /* 3. Card Styling (Updated to #1e1e20 to match Login) */
    .card {
      background-color: #1e1e20; /* Darker grey like Login */
      border: 1px solid #333333; /* Darker border like Login */
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.5); }

    /* 4. Typography & Headers */
    h1 { color: #ffffff; font-weight: 700; font-size: 1.8rem; margin: 0 0 10px 0; }
    h2 { color: #ffffff; font-weight: 600; font-size: 1.1rem; margin: 0 0 15px 0; }
    p.small-muted { color: #a1a1aa; margin: 0 0 20px 0; font-size: 0.9rem; }

    /* 5. Inputs (Updated to #121212 to match Login) */
    label { display: block; font-size: 0.85rem; color: #a1a1aa; margin-bottom: 6px; margin-top: 10px; }
    
    input[type="text"], input[type="number"], select { 
      width: 100%; 
      background-color: #121212; /* Darker input bg like Login */
      border: 1px solid #3f3f46; 
      color: #ffffff; 
      padding: 12px; 
      border-radius: 8px; 
      font-size: 0.95rem; 
      box-sizing: border-box; 
      transition: border-color .18s, box-shadow .18s; 
    }
    input:focus, select:focus { border-color: #a855f7; outline: none; box-shadow: 0 6px 18px rgba(168,85,247,0.12); }

    /* 6. Buttons (Matches Login) */
    .btn { 
        padding: 10px 20px; 
        border-radius: 8px; 
        border: none; 
        cursor: pointer; 
        font-weight: 600; 
        font-size: 0.9rem; 
        margin-top: 10px; 
        margin-right: 10px; 
        transition: background .2s; 
    }
    .btn-primary { background-color: #a855f7; color: #fff; }
    .btn-secondary { background-color: #3f3f46; color: #fff; }
    .btn-danger { background-color: #ef4444; color: #fff; padding: 8px 12px; font-size: 0.85rem; }

    /* Calculator Specific Styles (Layout for horizontal inputs) */
    .form-row { display: flex; gap: 15px; align-items: flex-end; }
    .form-row > div { flex: 1; }
    @media(max-width: 600px){ .form-row { flex-direction: column; align-items: stretch; } }

    /* Table Styling */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
    th { text-align: left; color: #a1a1aa; padding: 10px; border-bottom: 1px solid #333333; }
    td { padding: 10px; border-bottom: 1px solid #333333; color: #e4e4e7; }
    tr:hover td { background: rgba(255,255,255,0.01); }
    tr:last-child td { border-bottom: none; }
    
    /* Token & Messages */
    .token-show { background: #121212; border: 1px solid #333; color: #a1a1aa; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; }
    .muted { color: #a1a1aa; font-size: 13px; }
    .msg { margin-top: 8px; font-size: 14px; color: #e4e4e7; }

    /* Pills */
    .pill { display: inline-block; padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
    .pill-add { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .pill-subtract { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
    .pill-multiply { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
    .pill-divide { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
    
    /* Toast */
    .toast-wrap{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;pointer-events:none;z-index:999}
    .toast{background:#1e1e20;border:1px solid #333;color:#e4e4e7;padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);opacity:1;transform:translateY(0);transition:all 0.3s ease;font-size:0.9rem}
    .toast.success{border-left:4px solid #a855f7}
  </style>
</head>
<body>

  <div class="page-frame">
    <div class="container">
      
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:8px">
        <div>
          <h1>Calculations (BREAD)</h1>
          <p class="small-muted">Manage your calculations securely using your token.</p>
        </div>
        <div>
          <button id="logoutBtnCalc" class="btn btn-secondary" style="display:none">Logout</button>
        </div>
      </div>

      <div class="card" id="auth">
        <h2>Token</h2>
        <div style="margin-bottom:15px">
            <span class="muted">Current Token: </span>
            <span class="token-show" id="tokenShow">(not set)</span>
        </div>
        <label>Paste token (or use login page to store it):</label>
        <input id="tokenInput" type="text" placeholder="Paste raw token here" />
        <div style="margin-top:10px">
          <button id="setToken" class="btn btn-primary">Set Token</button>
          <button id="clearToken" class="btn btn-secondary">Clear</button>
          <span id="authMsg" class="muted" style="margin-left:12px"></span>
        </div>
      </div>

      

      <div class="card">
        <h2>Create / Edit Calculation</h2>
        <form id="calcForm" novalidate>
          <input type="hidden" id="calcId" />
          
          <div class="form-row">
            <div>
              <label>Operand A</label>
              <input id="a" type="number" step="any" required placeholder="10" />
            </div>
            <div>
              <label>Operation</label>
              <select id="type">
                <option value="add">add (+)</option>
                <option value="subtract">subtract (-)</option>
                <option value="multiply">multiply (*)</option>
                <option value="divide">divide (/)</option>
              </select>
            </div>
            <div>
              <label>Operand B</label>
              <input id="b" type="number" step="any" required placeholder="5" />
            </div>
          </div>

          <div id="formMsg" class="msg"></div>
          
          <div style="margin-top:15px">
            <button id="submitBtn" class="btn btn-primary" type="submit">Create</button>
            <button id="cancelEdit" type="button" class="btn btn-secondary" style="display:none;">Cancel</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>History</h2>
        <div id="listMsg" class="muted"></div>
        <!-- Quick Stats: Total / Last Result / Top Type (moved below Create/Edit) -->
        <div class="form-row three" style="margin-bottom:16px; margin-top:12px;">
          <div class="card" style="margin-bottom:0; padding:14px; text-align:center;">
            <div class="muted" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px;">Total</div>
            <div id="statTotal" style="font-size:1.4rem; font-weight:700; color:#fff; margin-top:6px;">0</div>
          </div>
          <div class="card" style="margin-bottom:0; padding:14px; text-align:center;">
            <div class="muted" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px;">Last Result</div>
            <div id="statLast" style="font-size:1.4rem; font-weight:700; color:#a855f7; margin-top:6px;">-</div>
          </div>
          <div class="card" style="margin-bottom:0; padding:14px; text-align:center;">
            <div class="muted" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px;">Top Type</div>
            <div id="statType" style="font-size:1.4rem; font-weight:700; color:#34d399; margin-top:6px;">-</div>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
          <input id="searchInput" type="text" placeholder="Search by ID or Result..." style="margin-bottom:0; flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#0f0f10; color:#fff" />
          <select id="filterType" style="margin-bottom:0; width:150px; padding:10px; border-radius:8px; background:#0f0f10; color:#fff; border:1px solid #333">
            <option value="all">All Types</option>
            <option value="add">Add</option>
            <option value="subtract">Subtract</option>
            <option value="multiply">Multiply</option>
            <option value="divide">Divide</option>
          </select>
          <button id="exportBtn" class="btn btn-secondary" style="margin-left:6px">Export JSON</button>
        </div>
        <table id="calcTable">
          <thead>
              <tr>
                  <th>ID</th>
                  <th>A</th>
                  <th>Type</th>
                  <th>B</th>
                  <th>Result</th>
                  <th style="text-align:right">Actions</th>
              </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script>
    const tokenKey = 'token';
    const tokenShow = document.getElementById('tokenShow');
    const tokenInput = document.getElementById('tokenInput');
    const setTokenBtn = document.getElementById('setToken');
    const clearTokenBtn = document.getElementById('clearToken');
    const authMsg = document.getElementById('authMsg');
    const authCard = document.getElementById('auth');
    let currentData = [];

    function showToken() {
      const t = localStorage.getItem(tokenKey);
      tokenShow.innerText = t ? (t.length > 20 ? t.slice(0, 16) + '...' : t) : '(not set)';
      // keep the token card visible so users can paste or inspect tokens at any time
      try{ if (authCard) authCard.style.display = 'block'; }catch(e){}
      // update logout button visibility if present
      try{ const logoutBtn = document.getElementById('logoutBtnCalc'); if (logoutBtn) logoutBtn.style.display = t ? 'inline-block' : 'none'; }catch(e){}
    }
    showToken();

    setTokenBtn.addEventListener('click', () => {
      const v = tokenInput.value.trim();
      if (!v) return authMsg.innerText = 'Enter token';
      localStorage.setItem(tokenKey, v);
      tokenInput.value = '';
      showToken();
      authMsg.innerText = '';
      showToast('Token set successfully', 'success');
      loadList();
    });

    clearTokenBtn.addEventListener('click', () => {
      localStorage.removeItem(tokenKey);
      showToken();
      authMsg.innerText = '';
      showToast('Token cleared', '');
      loadList();
    });

    const form = document.getElementById('calcForm');
    const aEl = document.getElementById('a');
    const bEl = document.getElementById('b');
    const typeEl = document.getElementById('type');
    const msg = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEdit = document.getElementById('cancelEdit');
    const tableBody = document.querySelector('#calcTable tbody');
    const listMsg = document.getElementById('listMsg');

    function authHeader() {
      const t = localStorage.getItem(tokenKey);
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    async function loadList() {
      tableBody.innerHTML = '';
      listMsg.innerText = '';
      try {
        const res = await fetch('/api/calculations', { headers: { ...authHeader(), 'Accept': 'application/json' } });
        if (res.status === 401) { listMsg.innerText = 'Unauthorized - please set token (login or paste below)'; if (authCard) authCard.style.display = 'block'; return; }
        const data = await res.json();
        if (!Array.isArray(data)) { listMsg.innerText = 'No calculations found'; return; }
        // store current data for export & client-side filtering
        currentData = data;
        // update quick stats
        try{
          document.getElementById('statTotal').innerText = data.length;
          if (data.length > 0) {
            const last = data[data.length - 1];
            document.getElementById('statLast').innerText = last.result;
            const types = data.map(c => c.type || '');
            const mode = types.sort((a,b) => types.filter(v => v===a).length - types.filter(v => v===b).length).pop() || '-';
            document.getElementById('statType').innerText = mode;
          } else {
            document.getElementById('statLast').innerText = '-';
            document.getElementById('statType').innerText = '-';
          }
        }catch(e){}

        data.forEach(c => {
          const tr = document.createElement('tr');
          const typeClass = 'pill-' + (c.type || '').toLowerCase();
          const typeHtml = `<span class="pill ${typeClass}">${c.type}</span>`;
          
          tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.a}</td>
            <td>${typeHtml}</td>
            <td>${c.b}</td>
            <td><strong>${c.result}</strong></td>
            <td style="text-align:right">
              <button data-id="${c.id}" class="btn btn-secondary edit" style="padding:6px 12px; margin:0">Edit</button>
              <button data-id="${c.id}" class="btn btn-danger del" style="padding:6px 12px; margin:0; margin-left:5px">Del</button>
            </td>`;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        listMsg.innerText = 'Network error - check console';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.innerText = '';
      const a = parseFloat(aEl.value);
      const b = parseFloat(bEl.value);
      const type = typeEl.value;
      if (isNaN(a) || isNaN(b)) { msg.innerText = 'Operands must be numbers'; return; }
      
      const payload = { a, b, type };
      const id = document.getElementById('calcId').value;
      
      try {
        let res;
        if (id) {
          res = await fetch('/api/calculations/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify(payload) });
        } else {
          res = await fetch('/api/calculations', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify(payload) });
        }
        
        if (res.status === 401) { msg.innerText = 'Unauthorized'; return; }
        if (res.status >= 400) { const j = await res.json(); msg.innerText = j.detail || 'Error'; return; }
        
        const j = await res.json();
        msg.innerText = '';
        showToast(id ? 'Calculation updated' : 'Calculation created', 'success');
        resetForm();
        loadList();
      } catch (err) { msg.innerText = 'Network error'; }
    });

    tableBody.addEventListener('click', async (e) => {
      if (e.target.classList.contains('edit')) {
        const id = e.target.getAttribute('data-id');
        const res = await fetch('/api/calculations/' + id, { headers: { ...authHeader() } });
        if (res.status === 200) {
          const c = await res.json();
          document.getElementById('calcId').value = c.id;
          aEl.value = c.a; bEl.value = c.b; typeEl.value = c.type;
          submitBtn.innerText = 'Update'; cancelEdit.style.display = 'inline-block';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      if (e.target.classList.contains('del')) {
        const delBtn = e.target;
        const id = delBtn.getAttribute('data-id');
        // if already in confirm mode (clicked Confirm), proceed
        if (delBtn.dataset.confirm === '1'){
          const res = await fetch('/api/calculations/' + id, { method: 'DELETE', headers: { ...authHeader() } });
          if (res.status === 200) { showToast('Deleted', ''); loadList(); }
          return;
        }

        // Prevent multiple confirm wrappers
        const actionCell = delBtn.parentNode;
        if (!actionCell) return;

        // hide original edit button while confirming
        const editBtn = actionCell.querySelector('.edit');
        if (editBtn) editBtn.style.display = 'none';

        // change delete button to Confirm
        delBtn.dataset.confirm = '1';
        delBtn._origText = delBtn.innerText;
        delBtn.innerText = 'Confirm';
        delBtn.style.background = '#b91c1c';

        // create a Cancel button next to it
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.style.marginLeft = '6px';
        cancelBtn.style.padding = '6px 12px';
        cancelBtn.innerText = 'Cancel';
        actionCell.appendChild(cancelBtn);

        // handler to cancel confirm state
        const clearConfirm = ()=>{
          try{
            delBtn.dataset.confirm = '0';
            delBtn.innerText = delBtn._origText || 'Del';
            delBtn.style.background = '';
            if (editBtn) editBtn.style.display = '';
            if (cancelBtn && cancelBtn.parentNode) cancelBtn.parentNode.removeChild(cancelBtn);
          }catch(e){}
        };

        cancelBtn.addEventListener('click', clearConfirm);

        // auto-revert after 4 seconds
        const t = setTimeout(()=>{ clearConfirm(); }, 4000);
        // if they click Confirm (delBtn) while in confirm state, we'll proceed above
      }
    });

    cancelEdit.addEventListener('click', () => resetForm());
    function resetForm() { document.getElementById('calcId').value = ''; aEl.value=''; bEl.value=''; submitBtn.innerText='Create'; cancelEdit.style.display='none'; msg.innerText=''; }

    function showToast(text, type){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div');
      el.className = 'toast' + (type?(' '+type):'');
      el.innerText = text;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=>wrap.removeChild(el),300) }, 2600);
    }

    // Export JSON handler
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) exportBtn.addEventListener('click', ()=>{
      try{
        const blob = new Blob([JSON.stringify(currentData || [], null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'calculations.json'; a.click(); URL.revokeObjectURL(url);
        showToast('Export started', '');
      }catch(e){ showToast('Export failed', ''); }
    });

    // Search & Filter logic
    const searchInput = document.getElementById('searchInput');
    const filterType = document.getElementById('filterType');
    function filterTable(){
      const term = (searchInput?.value || '').toLowerCase();
      const type = (filterType?.value || 'all');
      const rows = document.querySelectorAll('#calcTable tbody tr');
      rows.forEach(row=>{
        const id = (row.children[0].innerText || '').toLowerCase();
        const opType = (row.children[2].innerText || '').toLowerCase();
        const result = (row.children[4].innerText || '').toLowerCase();
        const matchesTerm = !term || id.includes(term) || result.includes(term);
        const matchesType = type === 'all' || opType.includes(type);
        row.style.display = (matchesTerm && matchesType) ? '' : 'none';
      });
    }
    if (searchInput) searchInput.addEventListener('keyup', filterTable);
    if (filterType) filterType.addEventListener('change', filterTable);

    // If the user just logged in, show a dialog prompting to copy the token to clipboard
    (function showTokenDialogIfNeeded(){
      try{
        if (localStorage.getItem('showTokenDialog') === '1'){
          const t = localStorage.getItem(tokenKey);
          localStorage.removeItem('showTokenDialog');
          if (!t) return;
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;backdrop-filter: blur(4px);';
          const box = document.createElement('div');
          box.style.cssText = 'background:#1f2937;color:#fff;padding:20px;border-radius:10px;max-width:720px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6);';
          box.innerHTML = `<h3 style="margin:0 0 10px 0">Copy your token</h3>
            <p style="margin:0 0 12px 0;color:#cbd5e1">Your login token is stored locally. For some browsers/sites you may need to paste it into the token field on the calculations page. You can copy it now:</p>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
              <input id="_copyTokenInput" style="flex:1;padding:10px;border-radius:6px;border:1px solid #374151;background:#111;color:#fff;font-family:monospace" value="${t}" readonly />
              <button id="_copyTokenBtn" style="background:#a855f7;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer">Copy</button>
            </div>
            <div style="text-align:right"><button id="_closeTokenBtn" style="background:#374151;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Close</button></div>`;
          overlay.appendChild(box);
          document.body.appendChild(overlay);
          const copyBtn = document.getElementById('_copyTokenBtn');
          const copyInput = document.getElementById('_copyTokenInput');
          const closeBtn = document.getElementById('_closeTokenBtn');
          copyBtn.addEventListener('click', async ()=>{
            try{
              await navigator.clipboard.writeText(copyInput.value);
              showToast('Token copied to clipboard', 'success');
            }catch(e){
              // fallback
              copyInput.select();
              document.execCommand('copy');
              showToast('Token copied (fallback)', 'success');
            }
          });
          closeBtn.addEventListener('click', ()=>{ document.body.removeChild(overlay); });
          // Auto-close the copy dialog after a reasonable interval so users can copy it,
          // but tests won't be blocked. Keep it visible longer (6s) so it doesn't vanish
          // immediately during manual use.
          setTimeout(()=>{ try{ if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); }catch(e){} }, 6000);
        }
      }catch(e){ }
    })();

    // Logout button logic (visible on calculations page)
    (function setupLogoutButton(){
      try{
        const logoutBtn = document.getElementById('logoutBtnCalc');
        if (!logoutBtn) return;
        function updateLogoutBtn(){ const t = localStorage.getItem(tokenKey); logoutBtn.style.display = t ? 'inline-block' : 'none'; }
        updateLogoutBtn();
        logoutBtn.addEventListener('click', ()=>{
          localStorage.removeItem(tokenKey);
          showToken();
          showToast('Logged out', '');
          setTimeout(()=> window.location.href = '/login', 700);
        });
      }catch(e){ }
    })();

    loadList();
  </script>
</body>
</html>